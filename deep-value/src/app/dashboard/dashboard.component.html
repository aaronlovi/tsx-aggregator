<div class="page-header">
  <div class="page-header__left">
    <h2 class="page-title">Dashboard</h2>
    <div class="page-header__subtitle">
      @if (lastUpdated) {
        <span class="page-header__last-updated">
          Last refreshed at: {{ lastUpdated | date:'yyyy-MM-dd HH:mm:ss' }} ({{ lastUpdated | relativeTime:now }})
        </span>
      }
      @if (nextAutoRefreshTime) {
        <span class="page-header__next-refresh">
          Auto-refresh {{ nextAutoRefreshTime | relativeTime:now }}
        </span>
      }
    </div>
  </div>
  <button mat-raised-button color="primary" (click)="refreshData()" [disabled]="loading" class="page-header__refresh">
    <mat-icon>refresh</mat-icon>
    Refresh Data
  </button>
</div>

@if (loading) {
  <div class="dashboard__loading">Loading...</div>
}
@if (errorMsg) {
  <div class="dashboard__error">{{ errorMsg }}</div>
}

@if (stats) {
  <div class="dashboard__grid">
    <mat-card class="dashboard__card">
      <mat-card-header>
        <mat-card-title>Instruments</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="dashboard__stat">
          <span class="dashboard__stat-value">{{ stats.totalActiveInstruments | number }}</span>
          <span class="dashboard__stat-label">Active</span>
        </div>
        <div class="dashboard__stat">
          <span class="dashboard__stat-value">{{ stats.totalObsoletedInstruments | number }}</span>
          <span class="dashboard__stat-label">Obsoleted</span>
        </div>
        <div class="dashboard__stat">
          <span class="dashboard__stat-value">{{ stats.instrumentsWithProcessedReports | number }}</span>
          <span class="dashboard__stat-label">With Processed Reports</span>
        </div>
        <div class="dashboard__stat">
          <span class="dashboard__stat-value">{{ stats.instrumentsWithoutProcessedReports | number }}</span>
          <span class="dashboard__stat-label">Without Processed Reports</span>
        </div>
      </mat-card-content>
    </mat-card>
    <mat-card class="dashboard__card">
      <mat-card-header>
        <mat-card-title>Raw Reports by Type</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        @for (rc of stats.rawReportCounts; track rc) {
          <div class="dashboard__stat">
            <span class="dashboard__stat-value">{{ rc.count | number }}</span>
            <span class="dashboard__stat-label">{{ rc.reportTypeName }}</span>
          </div>
        }
      </mat-card-content>
    </mat-card>
    <mat-card class="dashboard__card">
      <mat-card-header>
        <mat-card-title>Processing</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="dashboard__stat">
          <span class="dashboard__stat-value">{{ stats.mostRecentRawIngestion | relativeTime:now }}</span>
          <span class="dashboard__stat-label">Last Instrument Data Fetch</span>
        </div>
        <div class="dashboard__stat">
          <span class="dashboard__stat-value">{{ stats.mostRecentAggregation | relativeTime:now }}</span>
          <span class="dashboard__stat-label">Last Aggregation</span>
        </div>
        <div class="dashboard__stat">
          <span class="dashboard__stat-value">{{ stats.unprocessedEventCount | number }}</span>
          <span class="dashboard__stat-label">Unprocessed Events</span>
        </div>
      </mat-card-content>
    </mat-card>
    <mat-card class="dashboard__card">
      <mat-card-header>
        <mat-card-title>Schedule</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="dashboard__stat">
          <span class="dashboard__stat-value">{{ stats.nextFetchInstrumentDataTime | relativeTime:now }}</span>
          <span class="dashboard__stat-label">Next Instrument Data Fetch</span>
        </div>
        <div class="dashboard__stat">
          <span class="dashboard__stat-value">{{ stats.nextFetchDirectoryTime | relativeTime:now }}</span>
          <span class="dashboard__stat-label">Next Directory Fetch</span>
        </div>
        <div class="dashboard__stat">
          <span class="dashboard__stat-value">{{ stats.nextFetchQuotesTime | relativeTime:now }}</span>
          <span class="dashboard__stat-label">Next Quotes Fetch</span>
        </div>
        <div class="dashboard__stat">
          <span class="dashboard__stat-value">{{ stats.nextAggregatorCycleTime | relativeTime:now }}</span>
          <span class="dashboard__stat-label">Next Aggregator Cycle</span>
        </div>
      </mat-card-content>
    </mat-card>
  </div>
}

@if (aggregatesLoading) {
  <div class="dashboard__loading">Loading company aggregates...</div>
}
@if (aggregatesErrorMsg) {
  <div class="dashboard__error">{{ aggregatesErrorMsg }}</div>
}

@if (aggregates) {
  <div class="dashboard__grid">
    <mat-card class="dashboard__card dashboard__card--wide">
      <mat-card-header>
        <mat-card-title>Company Analysis</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="dashboard__score-grid">
          <div class="dashboard__score-column">
            <div class="dashboard__stat">
              <span class="dashboard__stat-value">{{ aggregates.totalCompanies | number }}</span>
              <span class="dashboard__stat-label">Total Companies</span>
            </div>
            <div class="dashboard__stat">
              <span class="dashboard__stat-value">{{ aggregates.companiesWithPriceData | number }}</span>
              <span class="dashboard__stat-label">With Price Data</span>
            </div>
            <div class="dashboard__stat">
              <span class="dashboard__stat-value">{{ aggregates.companiesWithoutPriceData | number }}</span>
              <span class="dashboard__stat-label">Without Price Data</span>
            </div>
            <div class="dashboard__stat">
              <span class="dashboard__stat-value">{{ aggregates.companiesPassingAllChecks | number }}</span>
              <span class="dashboard__stat-label">Passing All Checks</span>
            </div>
            <div class="dashboard__stat">
              <span class="dashboard__stat-value">{{ aggregates.totalMarketCap | compactCurrency }}</span>
              <span class="dashboard__stat-label">Total Market Cap</span>
            </div>
          </div>
          <div class="dashboard__score-column">
            <div class="dashboard__stat">
              <span class="dashboard__stat-value">{{ aggregates.averageEstimatedReturn_FromCashFlow | number:'1.2-2' }}%</span>
              <span class="dashboard__stat-label">Avg Return (Cash Flow)</span>
            </div>
            <div class="dashboard__stat">
              <span class="dashboard__stat-value">{{ aggregates.medianEstimatedReturn_FromCashFlow | number:'1.2-2' }}%</span>
              <span class="dashboard__stat-label">Median Return (Cash Flow)</span>
            </div>
            <div class="dashboard__stat">
              <span class="dashboard__stat-value">{{ aggregates.averageEstimatedReturn_FromOwnerEarnings | number:'1.2-2' }}%</span>
              <span class="dashboard__stat-label">Avg Return (Owner Earnings)</span>
            </div>
            <div class="dashboard__stat">
              <span class="dashboard__stat-value">{{ aggregates.medianEstimatedReturn_FromOwnerEarnings | number:'1.2-2' }}%</span>
              <span class="dashboard__stat-label">Median Return (Owner Earnings)</span>
            </div>
          </div>
        </div>
      </mat-card-content>
    </mat-card>
    <mat-card class="dashboard__card dashboard__card--wide">
      <mat-card-header>
        <mat-card-title>Score Distribution</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="dashboard__score-grid">
          <div class="dashboard__score-column">
            @for (sd of scoreDistributionLeft; track sd) {
              <div class="dashboard__stat"
                [ngClass]="{'dashboard__stat--top-score': sd.score === 15, 'dashboard__stat--near-top-score': sd.score === 14, 'dashboard__stat--close-to-top-score': sd.score === 13}">
                <span class="dashboard__stat-value">{{ sd.count | number }}</span>
                <span class="dashboard__stat-label">Score {{ sd.score }}</span>
              </div>
            }
          </div>
          <div class="dashboard__score-column">
            @for (sd of scoreDistributionRight; track sd) {
              <div class="dashboard__stat"
                [ngClass]="{'dashboard__stat--top-score': sd.score === 15, 'dashboard__stat--near-top-score': sd.score === 14, 'dashboard__stat--close-to-top-score': sd.score === 13}">
                <span class="dashboard__stat-value">{{ sd.count | number }}</span>
                <span class="dashboard__stat-label">Score {{ sd.score }}</span>
              </div>
            }
          </div>
        </div>
      </mat-card-content>
    </mat-card>
  </div>
}

@if (aggregates && aggregates.scoreCategoryStatistics.length > 0) {
  <div class="dashboard__table-section">
    <mat-card class="dashboard__card dashboard__card--full">
      <mat-card-header>
        <mat-card-title>Score Category Statistics</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="dashboard__table-wrapper">
          <table class="dashboard__table">
            <thead>
              <tr>
                <th>Score</th>
                <th>Count</th>
                <th class="dashboard__table-cell--right">Sum Mkt Cap</th>
                <th class="dashboard__table-cell--right">Mean Mkt Cap</th>
                <th class="dashboard__table-cell--right">Median Mkt Cap</th>
                <th class="dashboard__table-cell--right">Mean Return (CF)</th>
                <th class="dashboard__table-cell--right">Median Return (CF)</th>
                <th class="dashboard__table-cell--right">Mean Return (OE)</th>
                <th class="dashboard__table-cell--right">Median Return (OE)</th>
              </tr>
            </thead>
            <tbody>
              @for (s of aggregates.scoreCategoryStatistics; track s) {
                <tr [ngClass]="{'dashboard__table-row--top-score': s.score === 15, 'dashboard__table-row--near-top-score': s.score === 14, 'dashboard__table-row--close-to-top-score': s.score === 13}">
                  <td class="dashboard__table-cell--center">{{ s.score }}</td>
                  <td class="dashboard__table-cell--center">{{ s.count | number }}</td>
                  <td class="dashboard__table-cell--right">{{ s.sumMarketCap | compactCurrency }}</td>
                  <td class="dashboard__table-cell--right">{{ s.meanMarketCap | compactCurrency }}</td>
                  <td class="dashboard__table-cell--right">{{ s.medianMarketCap | compactCurrency }}</td>
                  <td class="dashboard__table-cell--right">{{ s.meanReturnFromCashFlow | number:'1.2-2' }}%</td>
                  <td class="dashboard__table-cell--right">{{ s.medianReturnFromCashFlow | number:'1.2-2' }}%</td>
                  <td class="dashboard__table-cell--right">{{ s.meanReturnFromOwnerEarnings | number:'1.2-2' }}%</td>
                  <td class="dashboard__table-cell--right">{{ s.medianReturnFromOwnerEarnings | number:'1.2-2' }}%</td>
                </tr>
              }
            </tbody>
          </table>
        </div>
      </mat-card-content>
    </mat-card>
  </div>
}
