# Dependabot Vulnerability Remediation Plan

## Context

GitHub Dependabot reported 68 vulnerabilities (3 critical, 26 high, 26 moderate, 13 low) on the default branch. Local analysis reveals:

- **.NET backend (src/)**: No vulnerable packages detected by `dotnet list package --vulnerable`
- **Angular frontend (deep-value/)**: 76 vulnerabilities detected by `npm audit` (2 critical, 51 high, 14 moderate, 9 low)

The count difference between Dependabot (68) and npm audit (76) is due to different counting methodologies. The root cause is the same set of outdated npm dependencies.

**Root cause**: The Angular frontend is on **Angular 16** (released June 2023, end-of-life). Nearly all vulnerabilities are transitive dependencies pulled in by the outdated Angular toolchain, webpack, and supporting packages.

## Vulnerability Summary

| Category | Key Packages | Severity | Issue |
|----------|-------------|----------|-------|
| Angular core | @angular/core, compiler, common | High | XSS via SVG attributes, XSRF token leakage |
| Webpack toolchain | webpack, webpack-dev-middleware, webpack-dev-server | High/Moderate | Path traversal, DOM clobbering XSS, SSRF |
| Express | express 4.15.2 | High | Multiple known vulnerabilities (very old) |
| ws | ws 7.x/8.x | High | DoS via HTTP headers |
| postcss | postcss | Critical | Line return parsing vulnerability |
| braces | braces | Critical | ReDoS |
| Build tools | esbuild, vite, tar, tmp | Moderate/Low | Various dev-time vulnerabilities |

## Recommended Approach: Drop SSR + Incremental Angular Upgrade (16 to 19)

Dropping SSR simplifies the upgrade significantly by eliminating the `@nguniversal` migration (previously the hardest step). It also removes `express` and `@angular/platform-server` as runtime dependencies.

### Phase 1: Remove SSR

Remove all server-side rendering infrastructure before upgrading Angular.

**Delete these files:**
- `deep-value/server.ts`
- `deep-value/src/main.server.ts`
- `deep-value/src/app/app.server.module.ts`
- `deep-value/tsconfig.server.json`

**Remove from `deep-value/package.json`:**
- `@nguniversal/express-engine` (dependency)
- `@nguniversal/builders` (devDependency)
- `@angular/platform-server` (dependency)
- `express` (dependency)
- `@types/express` (devDependency)

**Remove from `deep-value/package.json` scripts:**
- `dev:ssr`
- `serve:ssr`
- `build:ssr`
- `prerender`

**Remove from `deep-value/angular.json` architect targets:**
- `server` (lines 107-128)
- `serve-ssr` (lines 129-142)
- `prerender` (lines 143-161)

Run `npm install` to regenerate the lock file, then verify `npm run build` and `npm test` still work.

### Phase 2: Quick wins (non-breaking fixes)

1. Run `npm audit fix` in `deep-value/` to patch vulnerabilities resolvable without breaking changes (e.g., `ws`)
2. Verify the app still builds and tests pass

### Phase 3: Angular version-by-version upgrade

Angular's official guidance is to upgrade one major version at a time. Each step: run `ng update` for that version, fix breaking changes, verify build and tests.

**Upgrade path**: 16 -> 17 -> 18 -> 19

#### Step 3a: Angular 16 to 17

- `npx @angular/cli@17 update @angular/core@17 @angular/cli@17`
- `npx @angular/cli@17 update @angular/material@17 @angular/cdk@17`
- No SSR migration needed (already removed)

#### Step 3b: Angular 17 to 18

- `npx @angular/cli@18 update @angular/core@18 @angular/cli@18`
- `npx @angular/cli@18 update @angular/material@18 @angular/cdk@18`
- Address any deprecation removals

#### Step 3c: Angular 18 to 19

- `npx @angular/cli@19 update @angular/core@19 @angular/cli@19`
- `npx @angular/cli@19 update @angular/material@19 @angular/cdk@19`
- Address any deprecation removals

**Files likely modified**:
- `deep-value/package.json`
- `deep-value/package-lock.json`
- `deep-value/angular.json`
- `deep-value/tsconfig.json`
- `deep-value/src/main.ts`
- Components in `deep-value/src/app/` (if breaking API changes)

### Phase 4: Final audit and verification

1. Run `npm audit` to confirm all vulnerabilities are resolved
2. Run `npm test` to verify all tests pass
3. Run `npm run build` to verify production build
4. Manual smoke test of the Angular app (`npm start`)

## Verification Criteria

- `npm audit` in `deep-value/` reports 0 vulnerabilities (or only low-severity dev-only issues)
- `npm test` passes
- `npm run build` succeeds
- App loads and displays company data correctly at localhost:4200

## Risks and Notes

- **@ngneat/transloco** may need updating to a version compatible with Angular 19
- The upgrade will require a TypeScript version bump (currently ~5.1.3, Angular 19 requires ~5.5+)
- Karma/Jasmine test runner versions may also need updates
- If any step fails badly, we can stop at an intermediate Angular version that still resolves the critical/high vulnerabilities

## Execution Results

All phases completed successfully on 2026-02-12.

| Phase | Result |
|-------|--------|
| 1. Remove SSR | Done. Deleted 4 files, removed 5 packages, 3 angular.json targets, 4 scripts. Vulnerabilities: 76 → 66 |
| 2. npm audit fix | Done. Non-breaking patches applied. Vulnerabilities: 66 → 37 |
| 3a. Angular 16 → 17 | Done. TypeScript bumped to 5.4. angular.json migrated `browserTarget` → `buildTarget`. |
| 3b. Angular 17 → 18 | Done. `HttpClientModule` replaced with `provideHttpClient()`. Material theme SCSS migrated (6 files). |
| 3c. Angular 18 → 19 | Done. TypeScript bumped to 5.8. Components annotated with `standalone: false`. 1 template fix (`||` → `??`). |
| 4. Final audit | Done. Vulnerabilities: **76 → 5** (all dev-only: `tar` in `@angular/cli`, `webpack` in `@angular-devkit/build-angular`). |

**Remaining 5 vulnerabilities** are in dev/build-time transitive dependencies (`tar`, `webpack`) locked to `@angular/cli@19` and `@angular-devkit/build-angular@19`. These require Angular 20+ to resolve and do not affect production bundles.

## References

- Angular Update Guide: https://angular.dev/update-guide
